library(shiny)
library(shinydashboard)
library(shinyWidgets)
library(ggplot2)
library(dplyr)
library(stringr)
library(RColorBrewer)
library(ggpubr)
library(cowplot)
#remotes::install_github("coolbutuseless/ggpattern")
library(ggpattern)
library(forcats)
library(plotly)


source("data_prep.R")


ui <- dashboardPage(
  dashboardHeader(title = "Pay Inequalities"),
  dashboardSidebar(
    sidebarMenu(id="sidebar",
                menuItem("About the dashboard", tabName = "about", icon = icon("dashboard")),
                menuItem("Pay gap data", tabName = "paygap", icon = icon("th")),
                menuItem("Pay comparisons", tabName = "paycomparisons", icon = icon("th"), id="paycomparisons_input",
                         menuSubItem('Sex',
                           tabName = 'sex',
                           icon = icon('line-chart')),
                         menuSubItem('Working pattern',
                           tabName = 'wp',
                           icon = icon('line-chart')),
                         menuSubItem('Age group',
                           tabName = 'age',
                           icon = icon('line-chart')),
                         menuSubItem('Work region',
                           tabName = 'wr',
                           icon = icon('line-chart')),
                         menuSubItem('Occupation',
                           tabName = 'occ',
                           icon = icon('line-chart')),
                         menuSubItem('Industry',
                           tabName = 'ind',
                           icon = icon('line-chart')))
    )
  ),
  dashboardBody(setBackgroundColor("white", shinydashboard = TRUE),
                tags$script(HTML("$('body').addClass('fixed');")),
                tags$head(
                  tags$link(rel = "stylesheet", type = "text/css", href = "style.css")
                ),
                tabItems(
                  tabItem(tabName = "about",
                          h2("About the Pay Inequalities dashboard"),
                          p("This pay inequalities dashboard provides data which allows users to explore some of the differences in pay between different groups."),
                          h3("Pay gap data"),
                          p("The 'Pay gap data' tab allows user to see the median percentage difference in earnings compared to a base group.",br(),
                            "Pay gap data is available for:"),
                          h4("Gender"),
                          p("Source: ", a("ONS Gender pay gap 2018 revised", href='https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/annualsurveyofhoursandearningsashegenderpaygaptables')%>%tagAppendAttributes(class = 'link-style'), .noWS = c("after-begin", "before-end")),
                          p("Annual gender pay gap estimates for UK employees by age, occupation, industry, full-time and part-time, region and other geographies, and public and private sector. Compiled from the Annual Survey of Hours and Earnings."),
                          p("Tables used:"),
                          tags$ul(tags$li("Age Group Table 6.12"),
                                  tags$li("Work Region Occupation SOC10 (2) Table 2.12")),
                          h4("Disability"),
                          p("Source:", a("ONS Disability pay gap 2018 revised", href='https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/disability/datasets/rawpaygapsbydisability')%>%tagAppendAttributes(class = 'link-style'), .noWS = c("after-begin", "before-end")),
                          p("Raw pay gaps and median pay by disability and other personal characteristics, UK, 2018."),
                          p("Tables used:"),
                          tags$ul(tags$li("Table 1: Median Pay and Pay Gaps by disability"),
                                  tags$li("Table 2: Median Pay and Pay Gaps by disability and age"),
                                  tags$li("Table 3: Median pay and pay gaps by disability and sex"),
                                  tags$li("Table 4: Median Pay and Raw Pay Gap by disability and region"),
                                  tags$li("Table 5: Median Pay and Raw Pay Gap by disability and occupation"),
                                  tags$li("Table 6: Median Pay and Raw Pay Gap by disability by ethnicity"),
                                  tags$li("Table 8: Median Pay and Raw Pay Gap by disability by working pattern"),
                                  tags$li("Table 9: Median Pay and Raw Pay Gap by disability by impairment")),
                          h4("Ethnicity"),
                          p("Source:",a("ONS Ethnicity pay gap 2018 revised", href='https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/ethnicitypaygapreferencetables')%>%tagAppendAttributes(class = 'link-style'), .noWS = c("after-begin", "before-end")),
                          p("Ethnicity pay gap estimates for 2018 across different ethnicity breakdowns using the Annual Population Survey."),
                          p("Tables used:"),
                          tags$ul(tags$li("Table 3: Median hourly pay (5 categories) and percentage difference between hourly earnings with White employees")),
                          h3("Pay comparison data"),
                          p("The 'Pay comparisons' tab allows users to compare the median yearly earnings for different sub categories."),
                          p("Three sources are used for the pay comparison section:"),
                          tags$ol(tags$li(a("ONS Earnings and hours worked, age group: ASHE Table 6", href="https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/agegroupashetable6")%>%tagAppendAttributes(class = 'link-style'), .noWS = c("after-begin", "before-end"), "- Table 6.7a Annual Pay",
                                          br(), "Annual estimates of paid hours worked and earnings for UK employees by sex, and full-time and part-time, by age group."),
                                  tags$li(a("ONS Earnings and hours worked, region by occupation by two-digit SOC: ASHE Table 3", href="https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/regionbyoccupation2digitsocashetable3")%>%tagAppendAttributes(class = 'link-style'), .noWS = c("after-begin", "before-end"), "- Table 3.7a Annual Pay",
                                          br(), "Annual estimates of paid hours worked and earnings for UK employees by sex, and full-time and part-time, by region and two-digit Standard Occupational Classification 2010."),
                                  tags$li(a("ONS Earnings and hours worked, industry by two-digit SIC: ASHE Table 4", href="https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/earningsandworkinghours/datasets/industry2digitsicashetable4")%>%tagAppendAttributes(class = 'link-style'), .noWS = c("after-begin", "before-end"), "- Table 4.7a Annual Pay",
                                          br(), "Annual estimates of paid hours worked and earnings for UK employees by sex, and full-time and part-time, by two-digit Standard Industrial Classification 2007.")
                                  ),
                          p("Pay comparison data is available for:"),
                          tags$ul(
                            tags$li("Sex - data available from all sources 1, 2 and 3."),
                            tags$li("Working pattern - data available from all sources 1, 2 and 3."),
                            tags$li("Age group - data available from source 1."),
                            tags$li("Work region - data available from source 2."),
                            tags$li("Occupation - data available from source 2."),
                            tags$li("Industry - data available from source 3.")
                          ),
                          h4("About ASHE"),
                          p("The Annual Survey of Hours and Earnings (ASHE), carried out in April each year, is the most comprehensive source of information on the structure and distribution of earnings in the UK. ASHE provides information about the levels, distribution and make-up of earnings and paid hours worked for employees in all industries and occupations. The ASHE tables contain estimates of earnings for employees by sex and full-time or part-time status. Further breakdowns include by region, occupation, industry, age group and public or private sector."),
                          p("ASHE covers employee jobs in the United Kingdom. It does not cover the self-employed, nor does it cover employees not paid during the reference period."),
                          p("Hourly and weekly estimates are provided for the pay period that included a specified date in April. They relate to employees on adult rates of pay, whose earnings for the survey pay period were not affected by absence. Estimates for 2020 include employees who have been furloughed under the Coronavirus Job Retention Scheme (CJRS)."),
                          p("Annual estimates are provided for the tax year that ended on 5th April in the reference year. They relate to employees on adult rates of pay who have been in the same job for more than a year."),
                          p("ASHE is based on a 1% sample of jobs taken from HM Revenue and Customs' Pay As You Earn (PAYE) records. Consequently, individuals with more than one job may appear in the sample more than once.")
                  ),
                  tabItem(tabName = "paygap",
                          h2("Pay gap"),
                          fluidRow(
                            column(2, style = "height:550px;",
                                   radioGroupButtons("gap_radio", "Inequality type",
                                                     c("Sex"="Gender pay gap (%)",
                                                       "Disability"="Disability pay gap (%)",
                                                       "Ethnicity"="Ethnicity pay gap (%)"),
                                                     direction = "vertical"),
                                   radioButtons("breakdown_radio", "Breakdown",
                                                available_breakdowns[["Gender pay gap (%)"]],
                                                selected="WorkingPattern"
                                   ) %>%
                                     tagAppendAttributes(role = 'radiogroup')
                                   
                                   
                            ),
                            column(9, offset = 0.5,
                                   plotlyOutput("plot1")
                                   
                            )
                          ),
                          fluidRow(column(2,downloadButton("downloadData", textOutput("gap_download_text")%>%tagAppendAttributes(class = 'btn-download-text'), class = "btn-download")),
                                   column(10, htmlOutput("pay_gap_text")))
                          
                  ),
                  tabItem(tabName = "sex",
                          h2("Pay comparison: sex"),
                          fluidRow(
                            column(12, style = "height:650px;",
                                   pickerInput("sex_dropdown", "Sex",
                                                   levels(comparison_data$Sex)[levels(comparison_data$Sex)!="All"],
                                                   options = list(
                                                     `actions-box` = TRUE,
                                                     size = 15,
                                                     `selected-text-format` = "count > 0",
                                                     `none-selected-text`="No items selected"),
                                                   multiple = TRUE,
                                                   choicesOpt = list(
                                                     icon = c(rep("glyphicon-none", times=length(levels(comparison_data$Sex)[levels(comparison_data$Sex)!="All"])))
                                                   )),
                                       plotlyOutput("plot2")
                                       )),
                          fluidRow(column(3, downloadButton("downloadDataSex", textOutput("sex_download_text")%>%tagAppendAttributes(class = 'btn-download-text'), class = "btn-download")),
                                   column(9,
                                          h4("Definitions"),
                                          p(strong("Median:"), "The median is the value below which 50% of jobs fall. It is ONS's preferred measure of average earnings as it is less affected by a relatively small number of very high earners and the skewed distribution of earnings. It therefore gives a better indication of typical pay than the mean."),
                                          p(strong("Jobs:"), "Employees on adult rates who have been in the same job for more than a year."),
                                          h4("Annual changes"),
                                          p("Estimates of the change from the previous year are provided for the median and mean. It is important to note that these are not adjusted to account for changes in the composition of the labour market during that period. Such factors can influence the apparent change in medians or means independently of changes in individuals' earnings. For example, when there are more low-paying jobs in the labour market in one year compared to the previous year, this acts to decrease the median. Consequently, care should be taken when drawing conclusions about changes in pay for individuals over time."),
                                          h4("Quality measures"),
                                          p("The quality of an estimate is measured by its coefficient of variation (CV), which is the ratio of the standard error of an estimate to the estimate."),
                                          p(strong("Precise:"), "The CV values are less than or equal to 5%"),
                                          p(strong("Reasonably precise:"), "The CV values are greater than 5% and less than or equal to 10%"),
                                          p(strong("Acceptable:"), "The CV values are greater than 10% and less than or equal to 20%"),
                                          p("Estimates with a CV greater than 20% are suppressed from publication on quality grounds, along with those for which there is a risk of disclosure of individual employees or employers.")
                                          ))),
                  tabItem(tabName = "wp",
                          h2("Pay comparison: working pattern"),
                          fluidRow(
                            column(12, style = "height:650px;",
                                   pickerInput("wp_dropdown", "Working pattern",
                                                   levels(comparison_data$WorkingPattern)[levels(comparison_data$WorkingPattern)!="All"],
                                                   options = list(
                                                     `actions-box` = TRUE,
                                                     size = 15,
                                                     `selected-text-format` = "count>0",
                                                     `none-selected-text`="No items selected"),
                                                   multiple = TRUE,
                                                   choicesOpt = list(
                                                     icon = c(rep("glyphicon-none", times=length(levels(comparison_data$WorkingPattern)[levels(comparison_data$WorkingPattern)!="All"])))
                                                   )),
            
                                   plotlyOutput("plot3")
                                   )),
                          fluidRow(
                            column(3, downloadButton("downloadDataWP", textOutput("wp_download_text")%>%tagAppendAttributes(class = 'btn-download-text'), class = "btn-download")),
                            column(9,
                                   h4("Definitions"),
                                   p(strong("Median:"), "The median is the value below which 50% of jobs fall. It is ONS's preferred measure of average earnings as it is less affected by a relatively small number of very high earners and the skewed distribution of earnings. It therefore gives a better indication of typical pay than the mean."),
                                   p(strong("Jobs:"), "Employees on adult rates who have been in the same job for more than a year."),
                                   h4("Annual changes"),
                                   p("Estimates of the change from the previous year are provided for the median and mean. It is important to note that these are not adjusted to account for changes in the composition of the labour market during that period. Such factors can influence the apparent change in medians or means independently of changes in individuals' earnings. For example, when there are more low-paying jobs in the labour market in one year compared to the previous year, this acts to decrease the median. Consequently, care should be taken when drawing conclusions about changes in pay for individuals over time."),
                                   h4("Quality measures"),
                                   p("The quality of an estimate is measured by its coefficient of variation (CV), which is the ratio of the standard error of an estimate to the estimate."),
                                   p(strong("Precise:"), "The CV values are less than or equal to 5%"),
                                   p(strong("Reasonably precise:"), "The CV values are greater than 5% and less than or equal to 10%"),
                                   p(strong("Acceptable:"), "The CV values are greater than 10% and less than or equal to 20%"),
                                   p("Estimates with a CV greater than 20% are suppressed from publication on quality grounds, along with those for which there is a risk of disclosure of individual employees or employers.")
                                   )
                          )),
                  tabItem(tabName = "age",
                          h2("Pay comparison: age group"),
                          fluidRow(
                            column(12, style = "height:650px;",
                                   pickerInput("age_dropdown", "Age group",
                                                            levels(comparison_data$AgeGroup)[levels(comparison_data$AgeGroup)!="All"],
                                                            options = list(
                                                              `actions-box` = TRUE,
                                                              size = 15,
                                                              `selected-text-format` = "count>0",
                                                              `none-selected-text`="No items selected"),
                                                            multiple = TRUE,
                                                   choicesOpt = list(
                                                     icon = c(rep("glyphicon-none", times=length(levels(comparison_data$AgeGroup)[levels(comparison_data$AgeGroup)!="All"])))
                                                   )
                                   ),
                                   plotlyOutput("plot4")
                                   )),
                          fluidRow(
                            column(3, downloadButton("downloadDataAge", textOutput("age_download_text")%>%tagAppendAttributes(class = 'btn-download-text'), class = "btn-download")),
                            column(9,
                                   h4("Definitions"),
                                   p(strong("Median:"), "The median is the value below which 50% of jobs fall. It is ONS's preferred measure of average earnings as it is less affected by a relatively small number of very high earners and the skewed distribution of earnings. It therefore gives a better indication of typical pay than the mean."),
                                   p(strong("Jobs:"), "Employees on adult rates who have been in the same job for more than a year."),
                                   h4("Annual changes"),
                                   p("Estimates of the change from the previous year are provided for the median and mean. It is important to note that these are not adjusted to account for changes in the composition of the labour market during that period. Such factors can influence the apparent change in medians or means independently of changes in individuals' earnings. For example, when there are more low-paying jobs in the labour market in one year compared to the previous year, this acts to decrease the median. Consequently, care should be taken when drawing conclusions about changes in pay for individuals over time."),
                                   h4("Quality measures"),
                                   p("The quality of an estimate is measured by its coefficient of variation (CV), which is the ratio of the standard error of an estimate to the estimate."),
                                   p(strong("Precise:"), "The CV values are less than or equal to 5%"),
                                   p(strong("Reasonably precise:"), "The CV values are greater than 5% and less than or equal to 10%"),
                                   p(strong("Acceptable:"), "The CV values are greater than 10% and less than or equal to 20%"),
                                   p("Estimates with a CV greater than 20% are suppressed from publication on quality grounds, along with those for which there is a risk of disclosure of individual employees or employers.")
                                   )
                          )),
                  tabItem(tabName = "wr",
                          h2("Pay comparison: work region"),
                          fluidRow(
                            column(12, style = "height:650px;",
                                   pickerInput("wr_dropdown", "Work region",
                                                            levels(comparison_data$WorkRegion)[levels(comparison_data$WorkRegion)!="All"],
                                                            options = list(
                                                              `actions-box` = TRUE,
                                                              size = 15,
                                                              `selected-text-format` = "count>0",
                                                              `none-selected-text`="No items selected"),
                                                            multiple = TRUE,
                                                   choicesOpt = list(
                                                     icon = c(rep("glyphicon-none", times=length(levels(comparison_data$WorkRegion)[levels(comparison_data$WorkRegion)!="All"])))
                                                   )
                                   ),
                                   plotlyOutput("plot5")
                                   )),
                          fluidRow(
                            column(3, downloadButton("downloadDataWR",textOutput("wr_download_text")%>%tagAppendAttributes(class = 'btn-download-text'), class = "btn-download")),
                            column(9,
                                   h4("Definitions"),
                                   p(strong("Median:"), "The median is the value below which 50% of jobs fall. It is ONS's preferred measure of average earnings as it is less affected by a relatively small number of very high earners and the skewed distribution of earnings. It therefore gives a better indication of typical pay than the mean."),
                                   p(strong("Jobs:"), "Employees on adult rates who have been in the same job for more than a year."),
                                   h4("Annual changes"),
                                   p("Estimates of the change from the previous year are provided for the median and mean. It is important to note that these are not adjusted to account for changes in the composition of the labour market during that period. Such factors can influence the apparent change in medians or means independently of changes in individuals' earnings. For example, when there are more low-paying jobs in the labour market in one year compared to the previous year, this acts to decrease the median. Consequently, care should be taken when drawing conclusions about changes in pay for individuals over time."),
                                   h4("Quality measures"),
                                   p("The quality of an estimate is measured by its coefficient of variation (CV), which is the ratio of the standard error of an estimate to the estimate."),
                                   p(strong("Precise:"), "The CV values are less than or equal to 5%"),
                                   p(strong("Reasonably precise:"), "The CV values are greater than 5% and less than or equal to 10%"),
                                   p(strong("Acceptable:"), "The CV values are greater than 10% and less than or equal to 20%"),
                                   p("Estimates with a CV greater than 20% are suppressed from publication on quality grounds, along with those for which there is a risk of disclosure of individual employees or employers.")
                                   )
                          )),
                  tabItem(tabName = "occ",
                          h2("Pay comparison: occupation"),
                          fluidRow(
                            column(12, style = "height:650px;",
                                   pickerInput("occ_dropdown", "Occupation",
                                                            levels(comparison_data$Occupation)[levels(comparison_data$Occupation)!="All"],
                                                            options = list(
                                                              `actions-box` = TRUE,
                                                              size = 15,
                                                              `selected-text-format` = "count>0",
                                                              `none-selected-text`="No items selected"),
                                                            multiple = TRUE,
                                                   choicesOpt = list(
                                                     icon = c(rep("glyphicon-none", times=length(levels(comparison_data$Occupation)[levels(comparison_data$Occupation)!="All"])))
                                                   )
                                   ),
                                   plotlyOutput("plot6")
                                   )),
                          fluidRow(
                            column(3, downloadButton("downloadDataOcc", textOutput("occ_download_text")%>%tagAppendAttributes(class = 'btn-download-text'), class = "btn-download")),
                            column(9,
                                   h4("Definitions"),
                                   p(strong("Median:"), "The median is the value below which 50% of jobs fall. It is ONS's preferred measure of average earnings as it is less affected by a relatively small number of very high earners and the skewed distribution of earnings. It therefore gives a better indication of typical pay than the mean."),
                                   p(strong("Jobs:"), "Employees on adult rates who have been in the same job for more than a year."),
                                   h4("Annual changes"),
                                   p("Estimates of the change from the previous year are provided for the median and mean. It is important to note that these are not adjusted to account for changes in the composition of the labour market during that period. Such factors can influence the apparent change in medians or means independently of changes in individuals' earnings. For example, when there are more low-paying jobs in the labour market in one year compared to the previous year, this acts to decrease the median. Consequently, care should be taken when drawing conclusions about changes in pay for individuals over time."),
                                   h4("Quality measures"),
                                   p("The quality of an estimate is measured by its coefficient of variation (CV), which is the ratio of the standard error of an estimate to the estimate."),
                                   p(strong("Precise:"), "The CV values are less than or equal to 5%"),
                                   p(strong("Reasonably precise:"), "The CV values are greater than 5% and less than or equal to 10%"),
                                   p(strong("Acceptable:"), "The CV values are greater than 10% and less than or equal to 20%"),
                                   p("Estimates with a CV greater than 20% are suppressed from publication on quality grounds, along with those for which there is a risk of disclosure of individual employees or employers.")
                                   )
                          )),
                  tabItem(tabName = "ind",
                          h2("Pay comparison: industry"),
                          fluidRow(
                            column(12, style = "height:650px;",
                                   pickerInput("ind_dropdown", "Industry",
                                                            levels(comparison_data$Industry)[levels(comparison_data$Industry)!="All"],
                                                            options = list(
                                                              `actions-box` = TRUE,
                                                              size = 15,
                                                              `selected-text-format` = "count>0",
                                                              `none-selected-text`="No items selected"),
                                                            multiple = TRUE,
                                                   choicesOpt = list(
                                                     icon = c(rep("glyphicon-none", times=length(levels(comparison_data$Industry)[levels(comparison_data$Industry)!="All"]))),
                                                     subtext = ind_map
                                                   )
                                   ),
                                   plotlyOutput("plot7")
                                   )),
                          fluidRow(
                            column(3, downloadButton("downloadDataInd", textOutput("ind_download_text")%>%tagAppendAttributes(class = 'btn-download-text'), class = "btn-download")),
                            column(9,
                                   h4("Definitions"),
                                   p(strong("Median:"), "The median is the value below which 50% of jobs fall. It is ONS's preferred measure of average earnings as it is less affected by a relatively small number of very high earners and the skewed distribution of earnings. It therefore gives a better indication of typical pay than the mean."),
                                   p(strong("Jobs:"), "Employees on adult rates who have been in the same job for more than a year."),
                                   h4("Annual changes"),
                                   p("Estimates of the change from the previous year are provided for the median and mean. It is important to note that these are not adjusted to account for changes in the composition of the labour market during that period. Such factors can influence the apparent change in medians or means independently of changes in individuals' earnings. For example, when there are more low-paying jobs in the labour market in one year compared to the previous year, this acts to decrease the median. Consequently, care should be taken when drawing conclusions about changes in pay for individuals over time."),
                                   h4("Quality measures"),
                                   p("The quality of an estimate is measured by its coefficient of variation (CV), which is the ratio of the standard error of an estimate to the estimate."),
                                   p(strong("Precise:"), "The CV values are less than or equal to 5%"),
                                   p(strong("Reasonably precise:"), "The CV values are greater than 5% and less than or equal to 10%"),
                                   p(strong("Acceptable:"), "The CV values are greater than 10% and less than or equal to 20%"),
                                   p("Estimates with a CV greater than 20% are suppressed from publication on quality grounds, along with those for which there is a risk of disclosure of individual employees or employers.")
                                   )
                          )
                          
                  )
                )
  )
)




server <- function(input, output, session) {
  
  observe({
    x <- input$gap_radio
    
    # Can also set the label and select items
    updateRadioButtons(session, "breakdown_radio",
                       choices=available_breakdowns[[x]],
                       selected = available_breakdowns[[x]][1]
    )
  })
  

  dat <- reactive({
    keep<-c("Year", "Units", "Value", "comment")
    if (input$gap_radio=="Ethnicity pay gap (%)"){
      data<-paygap_data %>%
        filter(Units==input$gap_radio) %>%
        select(!!unlist(keep), input$breakdown_radio) %>%
        droplevels()
    }
    else {
      data<-paygap_data %>%
        filter(Units==input$gap_radio) %>%
        filter_at(vars(names(paygap_data)[!names(paygap_data) %in% append(keep, input$breakdown_radio)]), all_vars(.=="All"))%>%
        select(!!unlist(keep), input$breakdown_radio) %>%
        droplevels()
    }
  })
  
  fill<-reactive({
    fill<-input$breakdown_radio
  })
  
  gap_data_download<-reactive({
    data<-paygap_data %>%
      filter(Units==input$gap_radio) %>%
      select(Year,where(~length(unique(.))>1),comment)
  })
  
  output$downloadData <- downloadHandler(
    filename = function() {
      paste(input$gap_radio, ".csv", sep = "")
    },
    content = function(file) {
      write.csv(gap_data_download(), file, row.names = FALSE)
    }
  )
  

  output$downloadDataSex <- downloadHandler(
    filename = "PayComparison_sex.csv",
    content = function(file) {write.csv(sex_data_download, file, row.names = FALSE)}
  )
  
  output$downloadDataWP <- downloadHandler(
    filename = "PayComparison_wp.csv",
    content = function(file) {write.csv(wp_data_download, file, row.names = FALSE)}
  )

  output$downloadDataAge <- downloadHandler(
    filename = "PayComparison_age.csv",
    content = function(file) {write.csv(age_data_download, file, row.names = FALSE)}
  )  
  
  output$downloadDataWR <- downloadHandler(
    filename = "PayComparison_wr.csv",
    content = function(file) {write.csv(wr_data_download, file, row.names = FALSE)}
  )
  
  output$downloadDataOcc <- downloadHandler(
    filename = "PayComparison_occ.csv",
    content = function(file) {write.csv(occ_data_download, file, row.names = FALSE)}
  )
  
  output$downloadDataInd <- downloadHandler(
    filename = "PayComparison_ind.csv",
    content = function(file) {write.csv(ind_data_download, file, row.names = FALSE)}
  )
  
  output$gap_download_text <- renderText({ 
    paste("Download data for\n", input$gap_radio, "\nas CSV")
  })
  
  output$sex_download_text <- renderText({
    download_text
  })
  
  output$wp_download_text <- renderText({
    download_text
  })
  
  output$age_download_text <- renderText({
    download_text
  })
  
  output$wr_download_text <- renderText({
    download_text
  })
  
  output$occ_download_text <- renderText({
    download_text
  })
  
  output$ind_download_text <- renderText({
    download_text
  })
  
  
  output$pay_gap_text <- renderUI({
    if (input$gap_radio == "Gender pay gap (%)")
      HTML(paste("<h4>Interpretation</h4>",
                 "<p>It should be noted that the figures do not show differences in rates of pay for comparable jobs, as these are affected by factors such as the proportion of men and women working part time or in different occupations. For example, a higher proportion of women work in occupations such as administration and caring, which tend to offer lower salaries.</p>",
                 "<h4>Definitions</h4>",
                 "<p><strong>Gender pay gap (GPG):</strong> Calculated as the difference between average hourly earnings (excluding overtime) of men and women as a proportion of average hourly earnings (excluding overtime) of men. For example, a 4% GPG denotes that women earn 4% less, on average, than men. Conversely, a -4% GPG denotes that women earn 4% more, on average, than men.</p>",
                 "<p><strong>Median:</strong> The value below which 50% of jobs fall. It is ONS's preferred measure of average earnings as it is less affected by a relatively small number of very high earners and the skewed distribution of earnings. It therefore gives a better indication of typical pay than the mean.</p>",
                 "<p><strong>Full-time:</strong> Employees working more than 30 paid hours per week (or 25 or more for the teaching professions).</p>",
                 "<h4>Quality measures</h4>",
                 "<p>The quality of each estimate is based upon the coefficient of variation (CV) values for the corresponding male and female earnings estimates. The CV is the ratio of the standard error of an estimate to the estimate itself and is expressed as a percentage. The smaller the CV the greater the accuracy of the estimate.</p>",
                 "<p><strong>Precise:</strong> The CV values of both the male and female earnings estimates are less than or equal to 5%.",
                 "<h4>Coverage</h4>",
                 "<p>ASHE covers employee jobs in the United Kingdom. It does not cover the self-employed, nor does it cover employees not paid during the reference period.</p>",
                 "<p>GPG estimates are provided for the pay period that included a specified date in April. They relate to employees on adult rates of pay, whose earnings for the survey pay period were not affected by absence.</p>",
                 "<p>ASHE is based on a 1% sample of jobs taken from HM Revenue and Customs' Pay As You Earn (PAYE) records. Consequently, individuals with more than one job may appear in the sample more than once.</p>"))
    else if (input$gap_radio == "Disability pay gap (%)")
      HTML(paste("<h4>Population</h4>",
                 "<p>The analysis is restricted to people aged 16 to 64 due to the fact the survey does not collect disability status of people under 16 and only collects disability status in a restricted way (only at the first contact) for people aged 65 or over.</p>",
                 "<p>As disability status is only collected for people aged 65 or older at their first contact (generally wave 1) there is less data for this age group. The weight used to weight the sample up to the population does not account for the reduced sample size for this age group, making the data not fully representative of the population. The lack of an appropriate weight for the older age group means that restricting the analysis to the 16 to 64 age group is necessary.</p>",
                 "<h4>Definitions</h4>",
                 "<p><strong>Disability:</strong> The definition of disability used is consistent with the core definition of disability under the Equality Act 2010. A person is considered to have a disability if they have a long-standing illness, disability or impairment which causes difficulty with day-to-day activities.</p>",
                 "<p><strong>Impairment or condition:</strong> An impairment is defined as any physical or mental health conditions or illnesses lasting or expecting to last 12 months or more. Respondents were presented with a list of impairments and asked to select their 'main health problem'. The commentary in the report refers to the main health problem and does not explore where disabled people experienced more than one impairment.</p>",
                 "<h4>Quality measures</h4>",
                 "<p><strong>Precise:</strong> No quality issues listed for this value.</p>",
                 "<h4>Coverage</h4>",
                 "<p>The Annual Population Survey (APS) is an annual survey based on data collected in wave 1 and wave 5 on the Labour Force Survey (LFS), combined with an annual local area boost sample run in England, Wales, and Scotland. The survey does not cover communal establishments, except for NHS staff accommodation. Those living in student halls of residence or boarding school are included as part of their family household. The APS dataset contains approximately 300,000 individuals. The analysis in this publication was conducted on the July 2018 to June 2019 period as it provides the most up to date information.</p>"))
    else if (input$gap_radio == "Ethnicity pay gap (%)")
      HTML(paste("<h4>Population</h4>",
                 "<p>The analysis is restricted to employees aged 16 or over.",
                 "<h4>Definitions</h4>",
                 "<p>Black consists of Black/African/Caribbean/Black British.</p>",
                 "<p>For further information on the definition and presentation of ethnic groups and geographical coverage across the United Kingdom see <a href='https://gss.civilservice.gov.uk/policy-store/ethnicity/' class = 'link-style'>GSS Harmonised Principle for ethnic groupings</a>.</p>",
                 "<h4>Quality measures</h4>",
                 "<p><strong>Precise:</strong> No quality issues listed for this value.</p>",
                 "<h4>Coverage</h4>",
                 "<p>The Annual Population Survey (APS) is an annual survey based on data collected in wave 1 and wave 5 on the Labour Force Survey (LFS), combined with an annual local area boost sample run in England, Wales, and Scotland. The survey does not cover communal establishments, except for NHS staff accommodation. Those living in student halls of residence or boarding school are included as part of their family household. The APS data analysed covers January-December for each year from 2012-2019, with January-December 2019 being the most recent data available. All data were collected before the impact of Covid-19 on the UK economy.</p>"))
    
  })
  
  
  output$value_recommendation <- renderPrint({
    if(input$num > 150)
      "Loose Weight"
    else
      "Gain weight"
  })
  
  
  sex_dat_comparison <- reactive ({
    data<-sex_data_download %>%
      filter(Sex %in% c("All", input$sex_dropdown)) %>%
      arrange(Year)
  })
  
  wp_dat_comparison <- reactive ({
    data<-wp_data_download %>%
      filter(WorkingPattern %in% c("All", input$wp_dropdown)) %>%
      arrange(Year)
    
  })
  
  age_dat_comparison <- reactive ({
    data<-age_data_download %>%
      filter(AgeGroup %in% c("All", input$age_dropdown)) %>%
      arrange(Year)
    
  })
  
  wr_dat_comparison <- reactive ({
    data<-wr_data_download %>%
      filter(WorkRegion %in% c("All", input$wr_dropdown)) %>%
      arrange(Year)
    
  })
  
  occ_dat_comparison <- reactive ({
    data<-occ_data_download %>%
      filter(Occupation %in% c("All", input$occ_dropdown)) %>%
      arrange(Year)
    
  })
  
  ind_dat_comparison <- reactive ({
    data<-ind_data_download %>%
      filter(Industry %in% c("All", input$ind_dropdown)) %>%
      arrange(Year)
    
  })
  
  

  observeEvent(input$gap_radio,
               output$plot1<-renderPlotly({
                 plot<-plot_ly(dat(), y=~get(input$breakdown_radio), x=~Value, type="bar", marker=list(color='#00006ABF'),
                               orientation="h", height=550,
                               text = ~paste("<b>", get(input$breakdown_radio), "</b><br> Percentage (%): ", Value, "<br>",
                                             "Estimate quality: ", comment, "<extra></extra>"),
                               hovertemplate = "%{text}") %>%
                   layout(title=list(text=graph_titles[input$gap_radio], x = 0),
                          yaxis = list(title = list(text=gsub("([a-z])([A-Z])", "\\1 \\2", input$breakdown_radio), standoff=10), showgrid = FALSE,
                                       autorange="reversed"),
                          xaxis = list(title = "Percentage (%)", gridcolor = "#BEBEBE", zerolinewidth=2)) %>%
                   style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
                 ggplotly(plot)
                 })
               
               
  )
  


  
  
  
  
  output$plot2<-renderPlotly({
    plot<-plot_ly(total_data, x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers', color = ~Sex, colors = sexColours,
                  height=550,
                  text = ~paste("<b>", Sex, "</b><br> Median: ", Value, "<br>",
                                "Estimate quality: ", comment, "<extra></extra>"),
                  hovertemplate = "%{text}") %>%
      layout(title=list(text="Pay comparison by sex", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
             xaxis=list(showgrid = FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
             showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
      style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
    ggplotly(plot)
  })
  
  observeEvent(input$sex_dropdown,
               output$plot2<-renderPlotly({
                 plot<-plot_ly(sex_dat_comparison(), x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers', color = ~Sex, colors = sexColours,
                               height=550,
                               text = ~paste("<b>", Sex, "</b><br> Median: ", Value, "<br>",
                                             "Estimate quality: ", comment, "<extra></extra>"),
                               hovertemplate = "%{text}") %>%
                   layout(title=list(text="Pay comparison by sex", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
                          xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
                          showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
                   style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
                 ggplotly(plot)
                 
               })
               
  )
  
  
  output$plot3<-renderPlotly({
    plot<-plot_ly(total_data, x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers', color=~WorkingPattern, colors = wpColours,
                  height=550,
                  text = ~paste("<b>", WorkingPattern, "</b><br> Median: ", Value, "<br>",
                                "Estimate quality: ", comment, "<extra></extra>"),
                  hovertemplate = "%{text}") %>%
      layout(title=list(text="Pay comparison by working pattern", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
             xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
             showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
      style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
    ggplotly(plot)
    })
  
  observeEvent(input$wp_dropdown,
               output$plot3<-renderPlotly({
                 plot<-plot_ly(wp_dat_comparison(), x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers', color=~WorkingPattern, colors = wpColours,
                               height=550,
                               text = ~paste("<b>", WorkingPattern, "</b><br> Median: ", Value, "<br>",
                                             "Estimate quality: ", comment, "<extra></extra>"),
                               hovertemplate = "%{text}") %>%
                   layout(title=list(text="Pay comparison by working pattern", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
                          xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
                          showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
                   style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
                 ggplotly(plot)
                 })
               
  )
  


  output$plot4<-renderPlotly({
    plot<-plot_ly(total_data, x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers',
                  color=~AgeGroup, colors = ageColours, symbol=~AgeGroup,
                  height=550,
                  text = ~paste("<b>", AgeGroup, "</b><br> Median: ", Value, "<br>",
                                "Estimate quality: ", comment, "<extra></extra>"),
                  hovertemplate = "%{text}") %>%
      layout(title=list(text="Pay comparison by age group", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
             xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
             showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
      style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
    ggplotly(plot)
  })
  
  observeEvent(input$age_dropdown,
               output$plot4<-renderPlotly({
                 plot<-plot_ly(age_dat_comparison(), x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers',
                               color=~AgeGroup, colors = ageColours, symbol=~AgeGroup, symbols=ageShapes,
                               height=550,
                               text = ~paste("<b>", AgeGroup, "</b><br> Median: ", Value, "<br>",
                                             "Estimate quality: ", comment, "<extra></extra>"),
                               hovertemplate = "%{text}") %>%
                   layout(title=list(text="Pay comparison by age group", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
                          xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
                          showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
                   style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
                 ggplotly(plot)
               })
  )
                 
  

  
  output$plot5<-renderPlotly({
    plot<-plot_ly(total_data, x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers', color=~WorkRegion, colors = wrColours,
                  height=550,
                  text = ~paste("<b>", WorkRegion, "</b><br> Median: ", Value, "<br>",
                                "Estimate quality: ", comment, "<extra></extra>"),
                  hovertemplate = "%{text}") %>%
      layout(title=list(text="Pay comparison by work region", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
             xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
             showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
      style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
    ggplotly(plot)
  })
  
  
  observeEvent(input$wr_dropdown,
               output$plot5<-renderPlotly({
                 plot<-plot_ly(wr_dat_comparison(), x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers',
                               color=~WorkRegion, colors = wrColours, symbol=~WorkRegion, symbols=wrShapes,
                               height=550,
                               text = ~paste("<b>", WorkRegion, "</b><br> Median: ", Value, "<br>",
                                             "Estimate quality: ", comment, "<extra></extra>"),
                               hovertemplate = "%{text}") %>%
                   layout(title=list(text="Pay comparison by work region", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
                          xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
                          showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
                   style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
                 ggplotly(plot)
               })
  )
  
  
  
  output$plot6<-renderPlotly({
    plot<-plot_ly(total_data, x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers', color=~Occupation, colors = occColours,
                  height=550,
                  text = ~paste("<b>", Occupation, "</b><br> Median: ", Value, "<br>",
                                "Estimate quality: ", comment, "<extra></extra>"),
                  hovertemplate = "%{text}") %>%
      layout(title=list(text="Pay comparison by occupation", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
             xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
             showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
      style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
    ggplotly(plot)
  })
  
  observeEvent(input$occ_dropdown,
               output$plot6<-renderPlotly({
                 plot<-plot_ly(occ_dat_comparison(), x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers',
                               color=~Occupation, colors = occColours, symbol=~Occupation, symbols=occShapes,
                               height=550,
                               text = ~paste("<b>", Occupation, "</b><br> Median: ", Value, "<br>",
                                             "Estimate quality: ", comment, "<extra></extra>"),
                               hovertemplate = "%{text}") %>%
                   layout(title=list(text="Pay comparison by occupation", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
                          xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
                          showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
                   style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
                 ggplotly(plot)
               })
               )
  
  
  
  
  output$plot7<-renderPlotly({
    plot<-plot_ly(total_data, x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers', color=~Industry, colors = indColours,
                  height=550,
                  text = ~paste("<b>", Industry, ind_map2[Industry], "</b><br> Median: ", Value, "<br>",
                                "Estimate quality: ", comment, "<extra></extra>"),
                  hovertemplate = "%{text}") %>%
      layout(title=list(text="Pay comparison by industry", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"),
             xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)),
             showlegend=TRUE, legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
      style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
    ggplotly(plot)
  })
  
  observeEvent(input$ind_dropdown,
               output$plot7<-renderPlotly({
                 plot<-plot_ly(ind_dat_comparison(), x = ~Year, y = ~Value, type = 'scatter', mode = 'lines+markers',
                               color=~Industry, colors = indColours, symbol=~Industry, symbols=indShapes,
                               height=550,
                               text = ~paste("<b>", Industry, ind_map2[Industry], "</b><br> Median: ", Value, "<br>",
                                             "Estimate quality: ", comment, "<extra></extra>"),
                               hovertemplate = "%{text}") %>%
                   layout(title=list(text="Pay comparison by industry", x=0), yaxis = list(title = "Median", gridcolor = "#BEBEBE", tickformat=",d"), xaxis=list(showgrid=FALSE, tickvals = list(2016, 2017, 2018, 2019, 2020)), showlegend=TRUE,
                          legend = list(orientation = "h", xanchor = "center", x = 0.5, y=-0.15), margin=list(l=100)) %>%
                   style(hoverlabel = list(bgcolor = "#E5E5E5", bordercolor = "grey", font = list(family="Arial", color="black")))
                 ggplotly(plot)
               })
  )
  
  
}


# Run the application 
shinyApp(ui = ui, server = server)
